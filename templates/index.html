<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="shortcut icon" href="/static/your_tempo.ico" />
    <title>Your Tempo</title>
  </head>
  <body>
    <h1>Your Tempo</h1>
    <h3>(テンポ測定アプリ)</h3>
    <button id="spotifyLoginButton">Spotifyログイン</button>
    <p id="userNameDisplay"></p>

    <!-- 顔認識のオプション -->
    <h3>顔認識を利用しますか？</h3>
    <button id="cameraOptionYes">Yes</button>
    <button id="cameraOptionNo">No</button>

    <!-- カメラ映像表示部分（Yesが選択された場合のみ表示） -->
    <div id="cameraSection" style="display: none;">
      <video id="videoFeed" width="320" height="240" autoplay></video>
    </div>
    <p id="savePlaylistButtonContainer">
      <button id="savePlaylistButton">
        プレイリストを保存
      </button>
    </p>
    <h3>あなたの気分でタップしてね</h3>
    <div>
      <button id="tapButton">Tap</button>
    </div>
    <p id="tempoDisplay">Tempo: 0 BPM</p>
    <p id="playlist"></p>

    <script>
      // Spotify認証処理
      document
        .getElementById("spotifyLoginButton")
        .addEventListener("click", function () {
          window.location.href = "/login"; // サーバー側でSpotify認証ページにリダイレクト
        });

      // Spotifyユーザー名の表示
      fetch("/get_user_info")
        .then((response) => response.json())
        .then((data) => {
          if (data.userName) {
            document.getElementById(
              "userNameDisplay"
            ).textContent = `ようこそ、${data.userName}さん`;
            document.getElementById("spotifyLoginButton").style.display =
              "none"; // ログインボタンを非表示
          }
        });
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('cameraOptionYes').addEventListener('click', () => {
        document.getElementById('cameraSection').style.display = 'block';
        document.getElementById('tapButtonSection').style.display = 'block';
        startCamera();  // カメラ起動
      });

      document.getElementById('cameraOptionNo').addEventListener('click', () => {
        document.getElementById('tapButtonSection').style.display = 'block';
      });
    });

      // カメラの起動関数
      function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            document.getElementById('videoFeed').srcObject = stream;
          })
          .catch(err => {
            console.error("カメラの起動に失敗しました: ", err);
          });
      }

      let tapTimes = [];
      let tempo = 0;

      // Spotifyユーザーのトップアーティストを基におすすめの楽曲を取得
      function getTopTracks(access_token) {
        fetch("https://api.spotify.com/v1/me/top/artists?limit=5", {
          headers: {
            Authorization: "Bearer " + access_token,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const seed_artists = data.items
              .map((artist) => artist.id)
              .join(",");
            return fetch(
              `https://api.spotify.com/v1/recommendations?seed_artists=${seed_artists}&limit=10`,
              {
                headers: {
                  Authorization: "Bearer " + access_token,
                },
              }
            );
          })
          .then((response) => response.json())
          .then((recommendations) => {
            document.getElementById("playlist").innerHTML = `
					<h2>おすすめのプレイリスト:</h2>
					<ul>
							${recommendations.tracks
                .map(
                  (track) => `
									<li>
											<a href="https://open.spotify.com/track/${track.id}" target="_blank">
													${track.name} by ${track.artists?.[0]?.name || 'Unknown Artist'}
											</a>
									</li>
                  `
                )
                .join("")}
					</ul>`;
          });
      }

    // ボタン
    document.getElementById("tapButton").addEventListener("click", function () {
    const currentTime = Date.now();
    tapTimes.push(currentTime);

    // タップごとにボタンのサイズを拡大
    let currentSize = document.getElementById("tapButton").offsetWidth;
    let newSize = currentSize + 15;  // ボタンを15pxずつ拡大
    document.getElementById("tapButton").style.width = newSize + "px";
    document.getElementById("tapButton").style.height = newSize + "px";
    
    // タップ回数のカウントを追跡
    let tapCount = tapTimes.length;
    document.getElementById("tempoDisplay").textContent = `Tap Count: ${tapCount}`;

    if (tapTimes.length > 1) {
      const intervals = tapTimes.slice(1)
        .map((time, i) => time - tapTimes[i]);
      const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
      const tempo = Math.round(60000 / avgInterval);

      // アニメーション速度をテンポに合わせて調整
      let animationSpeed = 60 / tempo; // 1秒のアニメーションをテンポに合わせる
      document.getElementById("tapButton").style.setProperty('--animation-duration', `${animationSpeed}s`);

      // テンポ表示機能
      document.getElementById("tempoDisplay").textContent = `Tempo: ${tempo} BPM`;

      // 速度に応じてボタンの色を変更
      if (tempo >= 80) {
        document.getElementById("tapButton").style.backgroundColor = 'orange';
      } else {
        document.getElementById("tapButton").style.backgroundColor = 'lightgreen';
      }

      // タップ回数が5回に達したらプレイリストを生成
      if (tapTimes.length >= 5) {
        fetch("/generate_playlist", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ tempo: tempo }),
        })
          .then((response) => response.json())
          .then((data) => {
          // プレイリスト作成時に波紋のアニメーションを停止
          document.getElementById("tapButton").style.animation = 'none';
      // プレイリストのリンクを表示
      document.getElementById("playlist").innerHTML = `
        <h2>プレイリストが作成されました！</h2>
        <p>プレイリストはこちらから確認できます:</p>
        <a href="${data.playlist_url}" target="_blank">Spotifyでプレイリストを開く</a>
      `;

      // 楽曲リストを表示
      const filteredTracks = (data.tracks || []).filter(
        track => !/\b(BPM|bpm|tempo|TEMPO)\b/.test(track.name)
      );
      document.getElementById("playlist").innerHTML += `
        <ul>
          ${filteredTracks
            .map(
              (track) => `
              <li>
                <img src='${track.album_image}' width="50" height="50" />
                ${track.name} by ${track.artist}
              </li>
            `
            )
            .join("")}
        </ul>`;
    })
    .catch((error) => {
      alert("プレイリストの作成中にエラーが発生しました。もう一度お試しください。");
      console.error("エラー詳細:", error);
    });

        // ボタンの無効化とリセット
        document.getElementById("tapButton").disabled = true;
        document.getElementById("tempoDisplay").textContent = 'プレイリストを作成しました！';
        tapTimes = [];  // タップ履歴のリセット
      }
    }
  });

    </script>
  </body>
</html>
